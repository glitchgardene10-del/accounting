<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡Œæ”¿é›¶ç”¨é‡‘ç®¡ç† (v2.3 ä¿®æ­£ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” è«‹å…ˆç™»å…¥ï¼");
                window.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, deleteDoc, doc, updateDoc, increment, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.increment = increment;
        window.setDoc = setDoc;
        window.getDocs = getDocs;

        onAuthStateChanged(window.auth, (user) => {
            if (user) window.isAuthReady = true;
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = ["è†³é£Ÿè²»", "æ–‡å…·ç”¨å“", "éƒµé›»è²»", "äº¤é€š/æ²¹è³‡", "ä¿®ç¹•è²»", "é›œé …æ”¯å‡º", "äº¤éš›è²»", "å…¶ä»–"];
        
        const ExpenseLogApp = () => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(false);
            const [filterMonth, setFilterMonth] = useState(dayjs().format('YYYY-MM'));
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            const [cashBalance, setCashBalance] = useState(0);

            const [accountOptions, setAccountOptions] = useState([]); 

            // æ¨¡å¼ç‹€æ…‹ï¼šexpense(æ”¯å‡º), income(è£œå…¥), return(ç¹³å›)
            const [mode, setMode] = useState('expense'); 
            
            // è¡¨å–®æ¬„ä½
            const [date, setDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [item, setItem] = useState('');
            const [amount, setAmount] = useState('');
            const [category, setCategory] = useState('è†³é£Ÿè²»');
            
            // Payer ç‹€æ…‹ 
            const [selectedAccount, setSelectedAccount] = useState(''); 
            const [expenseType, setExpenseType] = useState('petty_cash'); 

            const [note, setNote] = useState('');
            // â˜…â˜…â˜… å‹•æ…‹åˆ¤æ–·è¿”å›é€£çµ â˜…â˜…â˜…
            const backLink = currentUser.role === 'manager' ? 'accounting_portal.html' : 'admin_portal.html';

            useEffect(() => {
                const startStr = `${filterMonth}-01`;
                const endStr = dayjs(filterMonth).endOf('month').format('YYYY-MM-DD');
                
                const q = window.query(
                    window.collection(window.db, "accounting_expenses"),
                    window.where("date", ">=", startStr),
                    window.where("date", "<=", endStr),
                    window.orderBy("date", "desc")
                );

                const unsub1 = window.onSnapshot(q, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    setEntries(list);
                });

                const unsub2 = window.onSnapshot(window.doc(window.db, "system_settings", "petty_cash"), (doc) => {
                    if (doc.exists()) setCashBalance(doc.data().balance || 0);
                    else window.setDoc(window.doc(window.db, "system_settings", "petty_cash"), { balance: 0 });
                });

                // â˜…â˜…â˜… ä¿®æ­£ï¼šæŠ“å– 1101 ~ 1105 åŠ 28xx â˜…â˜…â˜…
                const fetchAccounts = async () => {
                    try {
                        const qAcc = window.query(window.collection(window.db, "accounting_accounts"), window.orderBy("code"));
                        const snap = await window.getDocs(qAcc);
                        const opts = [];
                        snap.forEach(d => {
                            const data = d.data();
                            const code = String(data.code);
                            // ä¿®æ­£é»ï¼šåŠ å…¥ code.startsWith('1101')
                            if (code.startsWith('1101') || code.startsWith('1102') || code.startsWith('1103') || code.startsWith('1104') || code.startsWith('1105') || code.startsWith('28')) {
                                opts.push({ code: data.code, name: data.name });
                            }
                        });
                        
                        if (opts.length === 0) {
                            opts.push({ code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾' });
                            opts.push({ code: '2801', name: 'è‚¡æ±å¾€ä¾†' });
                        }
                        setAccountOptions(opts);
                        setSelectedAccount(opts[0]?.code || '');
                    } catch(e) { console.error("Fetch accounts error", e); }
                };
                fetchAccounts();

                return () => { unsub1(); unsub2(); };
            }, [filterMonth]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!item || !amount) return alert("è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡");
                if (!window.isAuthReady && !window.auth.currentUser) return alert("âš ï¸ è³‡æ–™åº«é€£ç·šä¸­ï¼Œè«‹ç¨å¾Œ...");

                setLoading(true);
                const val = Number(amount);

                let finalPayer = '';
                let finalCategory = category;
                
                if (mode === 'income') {
                    finalCategory = 'é›¶ç”¨é‡‘è£œçµ¦';
                    finalPayer = selectedAccount; 
                } else if (mode === 'return') {
                    finalCategory = 'ç¹³å›ç¾é‡‘';
                    finalPayer = selectedAccount; 
                } else { 
                    if (expenseType === 'petty_cash') finalPayer = '1101'; 
                    else if (expenseType === 'boss_paid') finalPayer = '2801'; 
                    else if (expenseType === 'bank') finalPayer = selectedAccount; 
                }

                try {
                    await window.addDoc(window.collection(window.db, "accounting_expenses"), {
                        date,
                        type: mode, 
                        item: (mode === 'income' ? `[å…¥é‡‘] ` : (mode === 'return' ? `[ç¹³å›] ` : ``)) + item,
                        amount: val,
                        category: finalCategory,
                        payer: finalPayer, 
                        note,
                        recorder: currentUser.name || 'Admin',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });

                    const pettyRef = window.doc(window.db, "system_settings", "petty_cash");

                    if (mode === 'income') {
                        await window.updateDoc(pettyRef, { balance: window.increment(val) });
                    } else if (mode === 'return') {
                        await window.updateDoc(pettyRef, { balance: window.increment(-val) });
                    } else if (mode === 'expense' && expenseType === 'petty_cash') {
                        await window.updateDoc(pettyRef, { balance: window.increment(-val) });
                    }
                    
                    setItem(''); setAmount(''); setNote('');
                    
                } catch (err) { console.error(err); alert("å„²å­˜å¤±æ•—ï¼š" + err.message); }
                setLoading(false);
            };

            const handleDelete = async (ent) => {
                if (ent.status === 'locked') return alert("â›” æ­¤ç­†è³‡æ–™å·²çµå¸³ï¼Œç„¡æ³•åˆªé™¤ï¼");
                if (!confirm(`ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ\né‡‘é¡: $${ent.amount}\n\næ³¨æ„ï¼šé€™å°‡æœƒã€Œå›æ»¾ã€é¤˜é¡è®Šå‹•ï¼`)) return;
                
                try {
                    await window.deleteDoc(window.doc(window.db, "accounting_expenses", ent.id));
                    const val = Number(ent.amount);
                    const pettyRef = window.doc(window.db, "system_settings", "petty_cash");

                    if (ent.type === 'income') {
                        await window.updateDoc(pettyRef, { balance: window.increment(-val) });
                    } else if (ent.type === 'return') {
                        await window.updateDoc(pettyRef, { balance: window.increment(val) });
                    } else if (ent.type === 'expense' && ent.payer === '1101') { 
                        await window.updateDoc(pettyRef, { balance: window.increment(val) });
                    }
                } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
            };

            const getPayerName = (code) => {
                if (code === '1101') return 'é›¶ç”¨é‡‘';
                const found = accountOptions.find(a => a.code === code);
                return found ? found.name : code; 
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-slate-50 shadow-2xl relative">
                    <div className="bg-slate-900 text-white p-5 sticky top-0 z-20 shadow-lg rounded-b-3xl">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <div className="text-xs text-slate-400 font-bold tracking-wider mb-1">CASH BOX BALANCE</div>
                                <div className={`text-4xl font-black font-mono ${cashBalance < 0 ? 'text-red-400' : 'text-emerald-400'}`}>
                                    ${new Intl.NumberFormat().format(cashBalance)}
                                </div>
                                <div className="text-[10px] text-slate-500 mt-1">ç›®å‰é›¶ç”¨é‡‘é¤˜é¡ (å¯¦é«”ç¾é‡‘)</div>
                            </div>
                            <a href={backLink} className="text-xs border border-slate-600 px-3 py-1 rounded-full hover:bg-slate-700 transition">é€€å‡º</a>
                        </div>
                        
                        <div className="flex bg-slate-800 p-1 rounded-xl gap-1">
                            <button onClick={()=>setMode('expense')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 ${mode==='expense' ? 'bg-red-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                <span>ğŸ’¸</span> æ”¯å‡º
                            </button>
                            <button onClick={()=>setMode('income')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 ${mode==='income' ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                <span>ğŸ“¥</span> è£œå…¥
                            </button>
                            <button onClick={()=>setMode('return')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 ${mode==='return' ? 'bg-blue-500 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                                <span>ğŸ“¤</span> ç¹³å›
                            </button>
                        </div>
                    </div>

                    <div className="p-4 bg-white m-4 rounded-2xl shadow-sm border border-slate-100">
                        <form onSubmit={handleSubmit} className="space-y-3">
                            <div className="grid grid-cols-3 gap-2">
                                <div className="col-span-1">
                                    <label className="text-xs font-bold text-slate-400 block mb-1">æ—¥æœŸ</label>
                                    <input type="date" required value={date} onChange={e=>setDate(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm font-bold bg-slate-50" />
                                </div>
                                <div className="col-span-2">
                                    <label className="text-xs font-bold text-slate-400 block mb-1">
                                        {mode==='expense' ? 'æ¶ˆè²»é …ç›®' : (mode==='income' ? 'ä¾†æºèªªæ˜' : 'ç¹³å›èªªæ˜')}
                                    </label>
                                    <input type="text" required 
                                        placeholder={mode==='expense' ? 'ä¾‹å¦‚: è²·ä¾¿ç•¶' : (mode==='income' ? 'ä¾‹å¦‚: è€é—†æ’¥æ¬¾' : 'ä¾‹å¦‚: å­˜å…¥éŠ€è¡Œ')} 
                                        value={item} onChange={e=>setItem(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm" />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                {mode === 'expense' && (
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 block mb-1">åˆ†é¡</label>
                                        <select value={category} onChange={e=>setCategory(e.target.value)} className="w-full p-2 rounded-lg border border-slate-200 text-sm bg-white">
                                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                )}

                                {(mode === 'income' || mode === 'return') && (
                                    <div>
                                        <label className={`text-xs font-bold block mb-1 ${mode==='income'?'text-emerald-600':'text-blue-600'}`}>
                                            {mode==='income' ? 'è³‡é‡‘ä¾†æº' : 'ç¹³å›å°è±¡'}
                                        </label>
                                        <select value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)} className={`w-full p-2 rounded-lg border-2 text-sm font-bold ${mode==='income'?'border-emerald-200 bg-emerald-50 text-emerald-900':'border-blue-200 bg-blue-50 text-blue-900'}`}>
                                            {accountOptions.map(opt => <option key={opt.code} value={opt.code}>{opt.code} {opt.name}</option>)}
                                        </select>
                                    </div>
                                )}

                                <div className={mode==='expense' ? '' : 'col-span-1'}>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">é‡‘é¡</label>
                                    <input type="number" required placeholder="$" value={amount} onChange={e=>setAmount(e.target.value)} className={`w-full p-2 rounded-lg border text-sm font-mono font-bold text-right text-lg ${mode==='income'?'border-emerald-200 text-emerald-600':(mode==='return'?'border-blue-200 text-blue-600':'border-red-200 text-red-600')}`} />
                                </div>
                            </div>

                            {mode === 'expense' && (
                                <div>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">å¾å“ªè£¡æ‰£æ¬¾?</label>
                                    <div className="flex gap-2 mb-2">
                                        <label className={`flex-1 border rounded p-2 text-xs text-center cursor-pointer ${expenseType==='petty_cash'?'bg-emerald-100 border-emerald-500 font-bold text-emerald-800':'bg-white'}`}>
                                            <input type="radio" name="etype" value="petty_cash" checked={expenseType==='petty_cash'} onChange={e=>setExpenseType(e.target.value)} className="hidden"/>
                                            ğŸ“¦ é›¶ç”¨é‡‘
                                        </label>
                                        <label className={`flex-1 border rounded p-2 text-xs text-center cursor-pointer ${expenseType==='boss_paid'?'bg-orange-100 border-orange-500 font-bold text-orange-800':'bg-white'}`}>
                                            <input type="radio" name="etype" value="boss_paid" checked={expenseType==='boss_paid'} onChange={e=>setExpenseType(e.target.value)} className="hidden"/>
                                            ğŸ‘‘ ä»£å¢Š
                                        </label>
                                        <label className={`flex-1 border rounded p-2 text-xs text-center cursor-pointer ${expenseType==='bank'?'bg-blue-100 border-blue-500 font-bold text-blue-800':'bg-white'}`}>
                                            <input type="radio" name="etype" value="bank" checked={expenseType==='bank'} onChange={e=>setExpenseType(e.target.value)} className="hidden"/>
                                            ğŸ’³ è½‰å¸³
                                        </label>
                                    </div>
                                    
                                    {expenseType === 'bank' && (
                                        <select value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)} className="w-full p-2 rounded-lg border-2 border-blue-200 text-sm bg-blue-50 text-blue-900 font-bold mb-2">
                                            {accountOptions.filter(a=>a.code.startsWith('11')).map(opt => <option key={opt.code} value={opt.code}>{opt.code} {opt.name}</option>)}
                                        </select>
                                    )}
                                    
                                    {expenseType !== 'petty_cash' && <div className="text-[10px] text-orange-500">* æ­¤é¸é …ä¸æœƒæ‰£é™¤ä¸Šæ–¹é›¶ç”¨é‡‘é¤˜é¡</div>}
                                </div>
                            )}

                            <button type="submit" disabled={loading} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95 flex justify-center items-center gap-2 ${mode==='income'?'bg-emerald-600 hover:bg-emerald-700':(mode==='return'?'bg-blue-600 hover:bg-blue-700':'bg-red-500 hover:bg-red-600')}`}>
                                {loading ? 'è™•ç†ä¸­...' : (mode==='income' ? 'ğŸ“¥ ç¢ºèªå…¥é‡‘ (å¢åŠ é¤˜é¡)' : (mode==='return' ? 'ğŸ“¤ ç¢ºèªç¹³å› (æ‰£é™¤é¤˜é¡)' : 'ğŸ’¸ ç¢ºèªæ”¯å‡º'))}
                            </button>
                        </form>
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 pb-safe-area-bottom">
                        <div className="flex justify-between items-center mb-2 px-2">
                            <h3 className="text-xs font-bold text-slate-400">æœ¬æœˆç´€éŒ„ ({dayjs(filterMonth).format('YYYY/MM')})</h3>
                            <input type="month" value={filterMonth} onChange={e=>setFilterMonth(e.target.value)} className="bg-transparent text-xs border border-slate-200 rounded p-1" />
                        </div>
                        
                        <div className="space-y-3 pb-20">
                            {entries.length === 0 ? (
                                <div className="text-center text-slate-300 py-10 text-sm">æœ¬æœˆå°šç„¡ç´€éŒ„</div>
                            ) : (
                                entries.map(ent => (
                                    <div key={ent.id} className={`p-3 rounded-xl border shadow-sm flex justify-between items-center relative ${ent.type==='income' ? 'bg-emerald-50 border-emerald-100' : (ent.type==='return' ? 'bg-blue-50 border-blue-100' : 'bg-white border-slate-100')} ${ent.status==='locked'?'opacity-60 grayscale':''}`}>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${ent.type==='income'?'bg-emerald-200 text-emerald-800':(ent.type==='return'?'bg-blue-200 text-blue-800':'bg-slate-200 text-slate-600')}`}>
                                                    {dayjs(ent.date).format('MM/DD')}
                                                </span>
                                                <span className="font-bold text-slate-800">{ent.item}</span>
                                                {ent.status === 'locked' && <span className="text-[10px] bg-gray-600 text-white px-1.5 py-0.5 rounded-full flex items-center gap-1">ğŸ”’ å·²çµå¸³</span>}
                                            </div>
                                            <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                <span>{ent.type==='income' ? 'å…¥é‡‘' : (ent.type==='return' ? 'ç¹³å›' : ent.category)}</span>
                                                <span>â€¢</span>
                                                <span>{ent.recorder}</span>
                                                <span className="text-orange-500 font-bold">â€¢ {getPayerName(ent.payer)}</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`font-bold text-lg font-mono ${ent.type==='income'?'text-emerald-600':(ent.type==='return'?'text-blue-600':'text-slate-700')}`}>
                                                {ent.type==='income' ? '+' : '-'}${new Intl.NumberFormat().format(ent.amount)}
                                            </div>
                                            {ent.status !== 'locked' && (
                                                <button onClick={() => handleDelete(ent)} className="text-[10px] text-red-300 hover:text-red-500 underline">åˆªé™¤</button>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExpenseLogApp />);
    </script>
</body>
</html>