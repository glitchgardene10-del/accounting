<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰ç¥æœƒè¨ˆå…§å¸³ç³»çµ± (v15.0 å¸³å–®é€£å‹•ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” éæ³•å­˜å–ï¼è«‹å…ˆç™»å…¥ã€‚");
                window.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, query, where, addDoc, orderBy, deleteDoc, doc, updateDoc, writeBatch, increment, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        window.collection = collection;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.query = query;
        window.where = where;
        window.addDoc = addDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.writeBatch = writeBatch;
        window.orderBy = orderBy;
        window.increment = increment;
        window.deleteField = deleteField;

        onAuthStateChanged(window.auth, (user) => {
            if (user && window.notifyAuthReady) window.notifyAuthReady();
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .bar-container { display: flex; align-items: flex-end; gap: 4px; height: 100px; }
        .bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s ease; position: relative; }
        .bar:hover .tooltip { opacity: 1; }
        .tooltip { opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: black; color: white; padding: 4px; font-size: 10px; border-radius: 4px; white-space: nowrap; pointer-events: none; transition: opacity 0.2s; z-index: 10; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const EXPENSE_MAP = {
            "è†³é£Ÿè²»": "5207", "æ–‡å…·ç”¨å“": "5204", "éƒµé›»è²»": "5203",
            "äº¤é€š/æ²¹è³‡": "5205", "ä¿®ç¹•è²»": "5206", "é›œé …æ”¯å‡º": "5299",
            "äº¤éš›è²»": "5299", "å…¶ä»–": "5299", "ç¹³å›ç¾é‡‘": "1105", "é›¶ç”¨é‡‘è£œçµ¦": "1105"
        };

        const PAYER_MAP = {
            "1105": "1105", "bank": "1102", "boss_paid": "2801"
        };

        const AccountingApp = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [journals, setJournals] = useState([]);
            const [accounts, setAccounts] = useState([]); 
            const [loading, setLoading] = useState(false);
            const [syncMonth, setSyncMonth] = useState(dayjs().subtract(1, 'month').format('YYYY-MM'));
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            
            const [pettyCashBalance, setPettyCashBalance] = useState(0); 

            // Filters
            const [journalFilterMonth, setJournalFilterMonth] = useState(dayjs().format('YYYY-MM'));
            const [ledgerFilterMonth, setLedgerFilterMonth] = useState(dayjs().format('YYYY-MM'));

            // Modals
            const [showModal, setShowModal] = useState(false);
            const [entryDate, setEntryDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [entryDesc, setEntryDesc] = useState('');
            const [entryRows, setEntryRows] = useState([{ account: '', debit: 0, credit: 0 }, { account: '', debit: 0, credit: 0 }]);

            const [showPayrollModal, setShowPayrollModal] = useState(false);
            const [payrollEmployees, setPayrollEmployees] = useState([]);

            const [selectedAccount, setSelectedAccount] = useState('');

            useEffect(() => {
                window.notifyAuthReady = () => setIsAuthReady(true);
                if (window.auth && window.auth.currentUser) setIsAuthReady(true);
            }, []);

            useEffect(() => {
                if (isAuthReady) {
                    fetchJournals();
                    fetchAccounts();
                    fetchPettyCash();
                }
            }, [isAuthReady]);

            const fetchPettyCash = async () => {
                try {
                    const docSnap = await window.getDoc(window.doc(window.db, "system_settings", "petty_cash"));
                    if(docSnap.exists()) setPettyCashBalance(docSnap.data().balance || 0);
                } catch(e) {}
            };

            const fetchJournals = async () => {
                setLoading(true);
                try {
                    const q = window.query(window.collection(window.db, "accounting_journal"), window.orderBy("date", "desc"));
                    const snap = await window.getDocs(q);
                    const list = [];
                    snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setJournals(list);
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            const fetchAccounts = async () => {
                try {
                    const q = window.query(window.collection(window.db, "accounting_accounts"), window.orderBy("code"));
                    const snap = await window.getDocs(q);
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    setAccounts(list);
                } catch (e) { console.error(e); }
            };

            const dashboardData = useMemo(() => {
                let totalBank = 0; 
                let totalCashBoss = 0; // 1101
                let revenueThisMonth = 0;
                let expenseThisMonth = 0;
                let personnelCost = 0; 
                
                const today = dayjs();
                const currentMonthPrefix = today.format('YYYY-MM');
                const last6Months = [];
                for(let i=5; i>=0; i--) {
                    last6Months.push({ month: today.subtract(i, 'month').format('YYYY-MM'), income: 0, expense: 0 });
                }

                journals.forEach(j => {
                    const jMonth = j.date.substring(0, 7);
                    
                    j.entries.forEach(e => {
                        const code = String(e.code || "");
                        const amount = Number(e.amount);

                        if (['1102', '1103', '1104', '1105'].some(prefix => code.startsWith(prefix)) && code !== '1105') { 
                            e.type === 'debit' ? totalBank += amount : totalBank -= amount;
                        }
                        
                        if (code.startsWith('1101')) {
                            e.type === 'debit' ? totalCashBoss += amount : totalCashBoss -= amount;
                        }

                        if (jMonth === currentMonthPrefix) {
                            if (code.startsWith('4')) {
                                e.type === 'credit' ? revenueThisMonth += amount : revenueThisMonth -= amount;
                            } else if (code.startsWith('5')) {
                                e.type === 'debit' ? expenseThisMonth += amount : expenseThisMonth -= amount;
                                if (code.startsWith('51')) personnelCost += amount; 
                            }
                        }

                        const monthData = last6Months.find(m => m.month === jMonth);
                        if (monthData) {
                            if (code.startsWith('4')) e.type === 'credit' ? monthData.income += amount : monthData.income -= amount;
                            if (code.startsWith('5')) e.type === 'debit' ? monthData.expense += amount : monthData.expense -= amount;
                        }
                    });
                });

                const netProfit = revenueThisMonth - expenseThisMonth;
                const profitMargin = revenueThisMonth > 0 ? (netProfit / revenueThisMonth * 100).toFixed(1) : 0;
                const personnelPercent = expenseThisMonth > 0 ? (personnelCost / expenseThisMonth * 100).toFixed(1) : 0;

                return { totalBank, totalCashBoss, revenueThisMonth, expenseThisMonth, netProfit, profitMargin, personnelCost, personnelPercent, trend: last6Months };
            }, [journals]);

            const fetchPayrollData = async () => {
                const checkQ = window.query(window.collection(window.db, "accounting_journal"), window.where("source", "==", `PAYROLL_${syncMonth}`));
                const checkSnap = await window.getDocs(checkQ);
                if(!checkSnap.empty) return alert("âš ï¸ è©²æœˆä»½è–ªè³‡å·²æ‹‹è½‰éï¼");

                setLoading(true);
                try {
                    let tempList = [];
                    const qCare = window.query(window.collection(window.db, "monthly_records"), window.where("yearMonth", "==", syncMonth));
                    const snapCare = await window.getDocs(qCare);
                    snapCare.forEach(doc => {
                        const d = doc.data();
                        if(d.finalResult) tempList.push({ id: doc.id, name: d.caregiverName||d.name, role: 'caregiver', gross: Number(d.finalResult.grossSalary)||0, net: Number(d.finalResult.netSalary)||0, pension: Number(d.finalResult.employerPension)||0, deduct: Number(d.finalResult.totalDeduction)||0, isCash: false });
                    });

                    const docRefAdmin = window.doc(window.db, "salary_records_admin", syncMonth);
                    const snapAdmin = await window.getDoc(docRefAdmin);
                    if(snapAdmin.exists()) {
                        Object.values(snapAdmin.data()).forEach(emp => {
                            if(emp.finalResult) tempList.push({ id: emp.employeeId, name: emp.name, role: 'admin', gross: Number(emp.finalResult.grossSalary)||0, net: Number(emp.finalResult.netSalary)||0, pension: Number(emp.finalResult.employerPension)||0, deduct: Number(emp.finalResult.totalDeduction)||0, isCash: false });
                        });
                    }

                    if (tempList.length === 0) alert(`âŒ [${syncMonth}] æŸ¥ç„¡è³‡æ–™`);
                    else {
                        tempList.sort((a,b) => (a.role === b.role) ? 0 : (a.role === 'admin' ? -1 : 1));
                        setPayrollEmployees(tempList);
                        setShowPayrollModal(true);
                    }
                } catch(e) { console.error(e); }
                setLoading(false);
            };

            const togglePaymentMethod = (index) => {
                const newList = [...payrollEmployees];
                newList[index].isCash = !newList[index].isCash;
                setPayrollEmployees(newList);
            };

            const confirmPayrollSync = async () => {
                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    let grossCare = 0, grossAdmin = 0, totalPension = 0, totalDeduct = 0, payoutBank = 0, payoutCash = 0;

                    payrollEmployees.forEach(emp => {
                        if (emp.role === 'caregiver') grossCare += emp.gross; else grossAdmin += emp.gross;
                        totalPension += emp.pension; totalDeduct += emp.deduct;
                        if (emp.isCash) payoutCash += emp.net; else payoutBank += emp.net;
                    });

                    const entries = [];
                    if (grossCare > 0) entries.push({ type: 'debit', code: '5101', name: 'è–ªè³‡æ”¯å‡º-å±…æœå“¡', amount: grossCare });
                    if (grossAdmin > 0) entries.push({ type: 'debit', code: '5101', name: 'è–ªè³‡æ”¯å‡º-è¡Œæ”¿', amount: grossAdmin });
                    if (totalPension > 0) entries.push({ type: 'debit', code: '5102', name: 'é€€ä¼‘é‡‘æ”¯å‡º', amount: totalPension });
                    if (payoutBank > 0) entries.push({ type: 'credit', code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾', amount: payoutBank });
                    
                    if (payoutCash > 0) entries.push({ type: 'credit', code: '1101', name: 'åº«å­˜ç¾é‡‘', amount: payoutCash });
                    
                    if (totalDeduct > 0) entries.push({ type: 'credit', code: '2201', name: 'ä»£æ‰£æ¬¾', amount: totalDeduct });
                    if (totalPension > 0) entries.push({ type: 'credit', code: '2204', name: 'æ‡‰ä»˜é€€ä¼‘é‡‘', amount: totalPension });

                    const journalRef = window.doc(window.collection(window.db, "accounting_journal"));
                    batch.set(journalRef, {
                        date: dayjs().format('YYYY-MM-DD'), 
                        description: `${syncMonth} è–ªè³‡ç™¼æ”¾`, 
                        source: `PAYROLL_${syncMonth}`, 
                        entries, 
                        totalAmount: grossCare + grossAdmin + totalPension, 
                        createdAt: new Date().toISOString(),
                        recorder: currentUser.name 
                    });

                    await batch.commit();
                    alert("âœ… è–ªè³‡æ‹‹è½‰æˆåŠŸï¼"); setShowPayrollModal(false); fetchJournals();
                } catch(e) { alert("å¤±æ•—ï¼š" + e.message); }
                setLoading(false);
            };

            const syncExpenses = async () => {
                setLoading(true);
                try {
                    const q = window.query(window.collection(window.db, "accounting_expenses"), window.where("status", "==", "pending"));
                    const snap = await window.getDocs(q);
                    if (snap.empty) { alert("æ²’æœ‰æœªå…¥å¸³çš„æµæ°´å¸³"); setLoading(false); return; }
                    if(!confirm(`æ‹‹è½‰ ${snap.size} ç­†æµæ°´å¸³ï¼Ÿ`)) { setLoading(false); return; }

                    let batchOps = window.writeBatch(window.db);
                    let entries = [], totalAmount = 0, idList = [];

                    snap.forEach(doc => {
                        const d = doc.data();
                        const amount = Number(d.amount);
                        let debitCode, creditCode;

                        if (d.type === 'expense') {
                            debitCode = EXPENSE_MAP[d.category] || "5299"; 
                            creditCode = d.payer === 'petty_cash' ? '1105' : (d.payer === 'boss_paid' ? '2801' : d.payer); 
                        } else if (d.type === 'income') {
                            debitCode = '1105'; 
                            creditCode = d.payer; 
                        } else if (d.type === 'return') {
                            debitCode = d.payer; 
                            creditCode = '1105'; 
                        }

                        entries.push({ type: 'debit', code: debitCode, name: d.category || 'é›œé …', amount });
                        entries.push({ type: 'credit', code: creditCode, name: 'å°æ–¹ç§‘ç›®', amount });

                        totalAmount += amount; 
                        idList.push(doc.id);
                        batchOps.update(doc.ref, { status: 'locked', lockedAt: new Date().toISOString() });
                    });

                    const journalRef = window.doc(window.collection(window.db, "accounting_journal"));
                    batchOps.set(journalRef, { 
                        date: dayjs().format('YYYY-MM-DD'), 
                        description: `åŒ¯å…¥è¡Œæ”¿æµæ°´å¸³ (${snap.size}ç­†)`, 
                        source: 'EXPENSE_IMPORT', 
                        entries, 
                        totalAmount, 
                        relatedExpenseIds: idList, 
                        createdAt: new Date().toISOString(),
                        recorder: currentUser.name 
                    });

                    await batchOps.commit(); alert("âœ… æ‹‹è½‰æˆåŠŸï¼"); fetchJournals();
                } catch(e) { console.error(e); alert("å¤±æ•—ï¼š" + e.message); }
                setLoading(false);
            };

            const deleteEntry = async (id) => {
                if(!confirm("ç¢ºå®šåˆªé™¤æ­¤å‚³ç¥¨ï¼Ÿ\nå¦‚æœæ˜¯æµæ°´å¸³æˆ–å¸³å–®æ”¯ä»˜ï¼Œç›¸é—œç´€éŒ„å°‡æœƒå›å¾©(Pending/Unpaid)ã€‚")) return;
                
                setLoading(true);
                try {
                    const docRef = window.doc(window.db, "accounting_journal", id);
                    const docSnap = await window.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const batch = window.writeBatch(window.db);

                        // 1. åå‘è§£é–æµæ°´å¸³
                        if (data.relatedExpenseIds && data.relatedExpenseIds.length > 0) {
                            data.relatedExpenseIds.forEach(expId => {
                                const expRef = window.doc(window.db, "accounting_expenses", expId);
                                batch.update(expRef, { status: 'pending', lockedAt: window.deleteField() });
                            });
                        }

                        // 2. â˜…â˜…â˜… åå‘è§£é–å¸³å–® (é—œéµé‚è¼¯) â˜…â˜…â˜…
                        if (data.relatedBillId) {
                            const billRef = window.doc(window.db, "bill_requests", data.relatedBillId);
                            batch.update(billRef, { 
                                status: 'pending', 
                                paidAt: window.deleteField(),
                                payer: window.deleteField(),
                                paymentMethod: window.deleteField(),
                                paymentSource: window.deleteField()
                            });
                        }

                        batch.delete(docRef);
                        await batch.commit();
                        alert("âœ… åˆªé™¤æˆåŠŸï¼Œç›¸é—œç´€éŒ„å·²å¾©åŸï¼");
                        fetchJournals();
                    }
                } catch(e) { console.error(e); alert("åˆªé™¤å¤±æ•—"); }
                setLoading(false);
            };

            const handleRowChange = (index, field, value) => {
                const newRows = [...entryRows]; newRows[index][field] = value; setEntryRows(newRows);
            };
            const addRow = () => setEntryRows([...entryRows, { account: '', debit: 0, credit: 0 }]);
            const removeRow = (index) => setEntryRows(entryRows.filter((_, i) => i !== index));

            const saveManualEntry = async () => {
                if (!entryDesc) return alert("è«‹è¼¸å…¥æ‘˜è¦");
                const entries = []; let debitSum = 0, creditSum = 0;
                entryRows.forEach(r => {
                    if (!r.account) return;
                    const acc = accounts.find(a => a.code === r.account);
                    if (Number(r.debit) > 0) { entries.push({ type: 'debit', code: r.account, name: acc?.name||'?', amount: Number(r.debit) }); debitSum += Number(r.debit); }
                    if (Number(r.credit) > 0) { entries.push({ type: 'credit', code: r.account, name: acc?.name||'?', amount: Number(r.credit) }); creditSum += Number(r.credit); }
                });
                if (entries.length === 0 || debitSum !== creditSum) return alert("å€Ÿè²¸ä¸å¹³è¡¡");
                try {
                    await window.addDoc(window.collection(window.db, "accounting_journal"), { date: entryDate, description: entryDesc, source: 'MANUAL', entries, totalAmount: debitSum, createdAt: new Date().toISOString(), recorder: currentUser.name });
                    alert("âœ… å„²å­˜æˆåŠŸ"); setShowModal(false); fetchJournals();
                } catch(e) { alert("å¤±æ•—"); }
            };

            const ledgerData = useMemo(() => {
                if(!selectedAccount) return [];
                let balance = 0;
                let fullHistory = journals.sort((a,b)=>dayjs(a.date).unix()-dayjs(b.date).unix()).map(j => {
                    const match = j.entries.find(e => e.code === selectedAccount);
                    if(!match) return null;
                    const d = match.type === 'debit' ? Number(match.amount) : 0;
                    const c = match.type === 'credit' ? Number(match.amount) : 0;
                    if(['1','5'].includes(selectedAccount[0])) balance += (d - c); else balance += (c - d);
                    return { date: j.date, desc: j.description, source: j.source, debit: d, credit: c, balance };
                }).filter(Boolean);

                const filterStart = ledgerFilterMonth; 
                const startIndex = fullHistory.findIndex(r => r.date.startsWith(filterStart));
                const filteredList = fullHistory.filter(r => r.date.startsWith(filterStart));

                if (startIndex > 0) {
                    filteredList.unshift({ date: `${filterStart}-01`, desc: "ã€æœŸåˆé¤˜é¡ / æ‰¿å‰é ã€‘", source: "SYSTEM", debit: 0, credit: 0, balance: fullHistory[startIndex - 1].balance, isOpening: true });
                } else if (startIndex === -1 && fullHistory.length > 0 && fullHistory[fullHistory.length-1].date < filterStart) {
                     filteredList.push({ date: `${filterStart}-01`, desc: "ã€æœŸåˆé¤˜é¡ã€‘", source: "SYSTEM", debit: 0, credit: 0, balance: fullHistory[fullHistory.length-1].balance, isOpening: true });
                }
                return filteredList;
            }, [journals, selectedAccount, ledgerFilterMonth]);

            const filteredJournals = useMemo(() => {
                return journals.filter(j => j.date.startsWith(journalFilterMonth));
            }, [journals, journalFilterMonth]);

            return (
                <div className="flex h-screen overflow-hidden">
                    <div className="w-64 bg-slate-900 text-white flex flex-col p-4 shadow-xl shrink-0">
                        <div className="text-2xl font-black tracking-widest mb-10 text-center">KUANG-YOU<div className="text-xs font-normal opacity-50 tracking-normal">ACCOUNTING</div></div>
                        <nav className="flex-1 space-y-2">
                            <button onClick={()=>setActiveTab('dashboard')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='dashboard'?'bg-blue-600 text-white':'hover:bg-slate-800 text-slate-400'}`}>ğŸ“Š è€é—†æˆ°æƒ…å®¤</button>
                            <button onClick={()=>setActiveTab('journal')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='journal'?'bg-blue-600 text-white':'hover:bg-slate-800 text-slate-400'}`}>ğŸ“’ æ—¥è¨˜å¸³ (æµæ°´)</button>
                            <button onClick={()=>setActiveTab('ledger')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='ledger'?'bg-blue-600 text-white':'hover:bg-slate-800 text-slate-400'}`}>ğŸ“‘ åˆ†é¡å¸³ (æ˜ç´°)</button>
                            <button onClick={()=>setActiveTab('sync')} className={`w-full text-left p-3 rounded-lg transition ${activeTab==='sync'?'bg-emerald-600 text-white':'hover:bg-slate-800 text-emerald-400'}`}>ğŸ”„ è‡ªå‹•æ‹‹è½‰ä½œæ¥­</button>
                        </nav>
                        <a href="accounting_portal.html" className="text-xs text-slate-500 text-center mt-auto hover:text-white pb-2">â† è¿”å›å…¥å£</a>
                    </div>

                    <div className="flex-1 bg-slate-100 overflow-auto p-8">
                        {/* â˜…â˜…â˜… Dashboard â˜…â˜…â˜… */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-2xl font-bold text-slate-800">ç¶“ç‡Ÿæ¦‚æ³æˆ°æƒ…å®¤</h2>
                                    <span className="text-sm text-slate-500">æ•¸æ“šæ›´æ–°: {dayjs().format('YYYY-MM-DD HH:mm')}</span>
                                </div>

                                <div className="grid grid-cols-3 gap-6">
                                    <div className="bg-gradient-to-br from-emerald-500 to-teal-700 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                        <div className="relative z-10">
                                            <div className="flex justify-between items-start">
                                                <div className="text-emerald-100 text-sm font-bold tracking-wider mb-1">CASH (1101 åº«å­˜ç¾é‡‘)</div>
                                            </div>
                                            <div className={`text-4xl font-black font-mono ${dashboardData.totalCashBoss < 0 ? 'text-red-300' : 'text-white'}`}>
                                                ${new Intl.NumberFormat().format(dashboardData.totalCashBoss)}
                                            </div>
                                            <div className="mt-4 text-xs opacity-80 border-t border-white/20 pt-2">è€é—†é‡‘åº« (æœƒè¨ˆå‚³ç¥¨å¯¦æ™‚è¨ˆç®—)</div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-orange-500 to-amber-700 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                        <div className="relative z-10">
                                            <div className="flex justify-between items-start">
                                                <div className="text-orange-100 text-sm font-bold tracking-wider mb-1">PETTY CASH (1105 é›¶ç”¨é‡‘)</div>
                                            </div>
                                            <div className={`text-4xl font-black font-mono ${pettyCashBalance < 0 ? 'text-red-300' : 'text-white'}`}>
                                                ${new Intl.NumberFormat().format(pettyCashBalance)}
                                            </div>
                                            <div className="mt-4 text-xs opacity-80 border-t border-white/20 pt-2">è¡Œæ”¿æ«ƒå° (å³æ™‚é€£ç·š)</div>
                                        </div>
                                    </div>
                                    <div className="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                        <div className="relative z-10">
                                            <div className="text-blue-100 text-sm font-bold tracking-wider mb-1">BANK (1102~ éŠ€è¡Œå­˜æ¬¾)</div>
                                            <div className="text-4xl font-black font-mono">${new Intl.NumberFormat().format(dashboardData.totalBank)}</div>
                                            <div className="mt-4 text-xs opacity-80 border-t border-white/20 pt-2">æ‰€æœ‰éŠ€è¡Œå¸³æˆ¶ç¸½è¨ˆ</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 col-span-2">
                                        <div className="flex justify-between items-end mb-4 border-b pb-2">
                                            <h3 className="font-bold text-slate-700 text-lg">æç›Šåˆ†æ ({dayjs().format('MMæœˆ')})</h3>
                                            <div className={`text-xl font-black ${dashboardData.netProfit >= 0 ? 'text-blue-600' : 'text-red-500'}`}>
                                                æ·¨åˆ©: ${new Intl.NumberFormat().format(dashboardData.netProfit)}
                                                <span className="text-sm ml-2 bg-slate-100 px-2 py-1 rounded text-slate-500">{dashboardData.profitMargin}%</span>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-8">
                                            <div>
                                                <div className="text-xs text-slate-400 mb-1">ç‡Ÿæ¥­æ”¶å…¥</div>
                                                <div className="h-4 bg-gray-100 rounded-full overflow-hidden">
                                                    <div className="h-full bg-emerald-500" style={{width: '100%'}}></div>
                                                </div>
                                                <div className="text-right font-bold mt-1 text-emerald-600">${new Intl.NumberFormat().format(dashboardData.revenueThisMonth)}</div>
                                            </div>
                                            <div>
                                                <div className="text-xs text-slate-400 mb-1">ç‡Ÿæ¥­è²»ç”¨ (å«è–ªè³‡)</div>
                                                <div className="h-4 bg-gray-100 rounded-full overflow-hidden">
                                                    <div className="h-full bg-red-500" style={{width: `${(dashboardData.expenseThisMonth / (dashboardData.revenueThisMonth || 1)) * 100}%`}}></div>
                                                </div>
                                                <div className="text-right font-bold mt-1 text-red-600">${new Intl.NumberFormat().format(dashboardData.expenseThisMonth)}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-slate-700 text-lg mb-4 border-b pb-2">äººäº‹æˆæœ¬ä½”æ¯”</h3>
                                        <div className="flex flex-col items-center justify-center h-32">
                                            <div className="text-5xl font-black text-slate-800">{dashboardData.personnelPercent}<span className="text-xl">%</span></div>
                                            <div className="text-xs text-slate-400 mt-2">äººäº‹æ”¯å‡º / ç¸½æ”¯å‡º</div>
                                        </div>
                                        <div className="text-center text-sm font-bold text-slate-600">
                                            $ {new Intl.NumberFormat().format(dashboardData.personnelCost)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ... (Sync, Journal, Ledger, Modals ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœç¯‡å¹…) ... */}
                        
                        {activeTab === 'sync' && (
                            <div className="grid grid-cols-2 gap-8">
                                <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 text-center flex flex-col items-center">
                                    <div className="text-5xl mb-4">ğŸ’°</div>
                                    <h2 className="text-2xl font-bold text-slate-800 mb-2">è–ªè³‡æ‹‹è½‰</h2>
                                    <p className="text-slate-500 mb-6 text-sm">è‡ªå‹•è¨ˆç®—è–ªè³‡ã€å‹å¥ä¿èˆ‡ä»˜æ¬¾æ–¹å¼</p>
                                    <input type="month" value={syncMonth} onChange={e=>setSyncMonth(e.target.value)} className="border rounded p-2 text-lg font-bold mb-4" />
                                    <button onClick={fetchPayrollData} disabled={loading} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-md disabled:opacity-50">ğŸš€ 1. æŠ“å–è³‡æ–™ & è¨­å®šæ”¯ä»˜æ–¹å¼</button>
                                </div>
                                <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 text-center flex flex-col items-center">
                                    <div className="text-5xl mb-4">ğŸ§¾</div>
                                    <h2 className="text-2xl font-bold text-slate-800 mb-2">æµæ°´å¸³æ‹‹è½‰</h2>
                                    <p className="text-slate-500 mb-6 text-sm">å°‡è¡Œæ”¿é›œæ”¯è½‰ç‚ºå‚³ç¥¨</p>
                                    <div className="h-[54px]"></div>
                                    <button onClick={syncExpenses} disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-md disabled:opacity-50">ğŸ“¥ åŒ¯å…¥æœªå…¥å¸³æ”¯å‡º</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'journal' && (
                            <div>
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-4">
                                        <h2 className="text-2xl font-bold text-slate-800">æ—¥è¨˜å¸³</h2>
                                        <input type="month" value={journalFilterMonth} onChange={e=>setJournalFilterMonth(e.target.value)} className="border-2 border-slate-300 rounded-lg p-1 font-bold text-slate-600" />
                                    </div>
                                    <button onClick={()=>setShowModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow">â• æ–°å¢åˆ†éŒ„</button>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    {filteredJournals.length === 0 ? <div className="p-10 text-center text-slate-400">æœ¬æœˆå°šç„¡å‚³ç¥¨è³‡æ–™</div> : (
                                        filteredJournals.map(j => (
                                            <div key={j.id} className="p-6 border-b hover:bg-slate-50">
                                                <div className="flex justify-between mb-2">
                                                    <span className="font-bold text-lg">{j.date} {j.description}</span>
                                                    <button onClick={()=>deleteEntry(j.id)} className="text-red-400 text-sm">åˆªé™¤</button>
                                                </div>
                                                <table className="w-full text-sm">
                                                    <tbody>
                                                        {j.entries.map((e, idx) => (
                                                            <tr key={idx}>
                                                                <td className="w-1/2">{e.name} <span className="text-slate-400 text-xs">({e.code})</span></td>
                                                                <td className="text-right w-1/4">{e.type==='debit' ? new Intl.NumberFormat().format(e.amount) : ''}</td>
                                                                <td className="text-right w-1/4">{e.type==='credit' ? new Intl.NumberFormat().format(e.amount) : ''}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'ledger' && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border min-h-[500px]">
                                <div className="flex gap-4 mb-4 items-center">
                                    <label className="font-bold">ç§‘ç›®ï¼š</label>
                                    <select className="border p-2 rounded w-64" value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)}>
                                        <option value="">è«‹é¸æ“‡...</option>
                                        {accounts.map(a => <option key={a.code} value={a.code}>{a.code} {a.name}</option>)}
                                    </select>
                                    <label className="font-bold ml-4">æœˆä»½ï¼š</label>
                                    <input type="month" value={ledgerFilterMonth} onChange={e=>setLedgerFilterMonth(e.target.value)} className="border p-2 rounded" />
                                </div>
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-100 font-bold">
                                        <tr><th className="p-2 text-left">æ—¥æœŸ</th><th className="p-2 text-left">æ‘˜è¦</th><th className="p-2 text-right">å€Ÿæ–¹</th><th className="p-2 text-right">è²¸æ–¹</th><th className="p-2 text-right">é¤˜é¡</th></tr>
                                    </thead>
                                    <tbody>
                                        {ledgerData.map((row, idx) => (
                                            <tr key={idx} className={`border-b hover:bg-slate-50 ${row.isOpening ? 'bg-yellow-50 font-bold text-slate-500' : ''}`}>
                                                <td className="p-2">{row.date}</td><td className="p-2">{row.desc}</td>
                                                <td className="p-2 text-right">{row.debit>0?new Intl.NumberFormat().format(row.debit):'-'}</td>
                                                <td className="p-2 text-right">{row.credit>0?new Intl.NumberFormat().format(row.credit):'-'}</td>
                                                <td className="p-2 text-right font-bold text-blue-600">{new Intl.NumberFormat().format(row.balance)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Modals: Payroll & Manual Entry (Same as before, keep them) */}
                        {showPayrollModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-slide-up">
                                    <div className="bg-slate-800 p-4 text-white font-bold flex justify-between items-center rounded-t-2xl">
                                        <span>ğŸ’° {syncMonth} è–ªè³‡æ”¯ä»˜è¨­å®š</span>
                                        <button onClick={()=>setShowPayrollModal(false)} className="text-slate-400 hover:text-white">âœ•</button>
                                    </div>
                                    <div className="p-6 overflow-y-auto flex-1">
                                        <div className="mb-4 text-sm text-slate-500 bg-yellow-50 p-3 rounded border border-yellow-200">
                                            ğŸ’¡ è«‹å‹¾é¸æœ¬æœˆã€Œé ˜å–ç¾é‡‘ã€çš„å“¡å·¥ï¼Œæœªå‹¾é¸è€…å°‡é è¨­ç‚ºã€ŒéŠ€è¡Œè½‰å¸³ã€ã€‚
                                            (ä¸‹æ–¹å°‡è‡ªå‹•åˆ†æµ <b>è–ªè³‡æ”¯å‡º-å±…æœå“¡</b> èˆ‡ <b>è–ªè³‡æ”¯å‡º-è¡Œæ”¿</b>)
                                        </div>
                                        <table className="w-full text-sm border-collapse">
                                            <thead>
                                                <tr className="bg-slate-100 text-slate-600 font-bold border-b">
                                                    <th className="p-3 text-left">å§“å</th>
                                                    <th className="p-3 text-left">è·ä½</th>
                                                    <th className="p-3 text-right">æ‡‰ç™¼è–ªè³‡ (Gross)</th>
                                                    <th className="p-3 text-right">å¯¦é ˜é‡‘é¡ (Net)</th>
                                                    <th className="p-3 text-center w-32">æ”¯ä»˜æ–¹å¼</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {payrollEmployees.map((emp, idx) => (
                                                    <tr key={idx} className={`hover:bg-blue-50 ${emp.isCash ? 'bg-orange-50' : ''}`}>
                                                        <td className="p-3 font-bold">{emp.name}</td>
                                                        <td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${emp.role==='caregiver'?'bg-green-100 text-green-700':'bg-purple-100 text-purple-700'}`}>{emp.role === 'caregiver' ? 'å±…æœå“¡' : 'è¡Œæ”¿'}</span></td>
                                                        <td className="p-3 text-right text-slate-400">${new Intl.NumberFormat().format(emp.gross)}</td>
                                                        <td className="p-3 text-right font-mono font-bold text-lg">${new Intl.NumberFormat().format(emp.net)}</td>
                                                        <td className="p-3 text-center cursor-pointer" onClick={()=>togglePaymentMethod(idx)}>
                                                            <div className={`border-2 rounded-lg px-2 py-1 text-xs font-bold transition select-none ${emp.isCash ? 'border-orange-500 bg-orange-100 text-orange-700' : 'border-slate-200 bg-white text-slate-400'}`}>{emp.isCash ? 'ğŸ’µ ç¾é‡‘' : 'ğŸ¦ è½‰å¸³'}</div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot className="bg-slate-50 font-bold">
                                                <tr>
                                                    <td colSpan="3" className="p-3 text-right">ç¸½è¨ˆï¼š</td>
                                                    <td className="p-3 text-right border-t-2 border-slate-300">${new Intl.NumberFormat().format(payrollEmployees.reduce((s,e)=>s+e.net,0))}</td>
                                                    <td className="p-3 text-center text-xs text-slate-500">(ç¾é‡‘: ${new Intl.NumberFormat().format(payrollEmployees.filter(e=>e.isCash).reduce((s,e)=>s+e.net,0))})</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div className="p-4 border-t bg-slate-50 flex justify-end gap-2 rounded-b-2xl">
                                        <button onClick={()=>setShowPayrollModal(false)} className="px-6 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded">å–æ¶ˆ</button>
                                        <button onClick={confirmPayrollSync} className="px-6 py-2 bg-emerald-600 text-white rounded font-bold hover:bg-emerald-700 shadow-lg flex items-center gap-2"><span>âœ… ç¢ºèªæ‹‹è½‰å‚³ç¥¨</span></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                    <div className="bg-slate-800 p-4 text-white font-bold flex justify-between items-center">
                                        <span>æ–°å¢å‚³ç¥¨ (Manual Entry)</span>
                                        <button onClick={()=>setShowModal(false)} className="text-slate-400 hover:text-white">âœ•</button>
                                    </div>
                                    <div className="p-6 overflow-y-auto flex-1">
                                        <div className="flex gap-4 mb-4">
                                            <div className="w-1/3"><label className="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" value={entryDate} onChange={e=>setEntryDate(e.target.value)} className="w-full border rounded p-2" /></div>
                                            <div className="w-2/3"><label className="block text-xs font-bold text-slate-500 mb-1">æ‘˜è¦èªªæ˜</label><input type="text" value={entryDesc} onChange={e=>setEntryDesc(e.target.value)} className="w-full border rounded p-2" placeholder="ä¾‹å¦‚: é–‹å¸³é¤˜é¡ã€ç¾é‡‘èª¿æ•´" /></div>
                                        </div>
                                        <table className="w-full text-sm mb-4">
                                            <thead className="bg-slate-50 text-slate-500 font-bold text-xs"><tr><th className="p-2 text-left">æœƒè¨ˆç§‘ç›®</th><th className="p-2 text-right">å€Ÿæ–¹ (Debit)</th><th className="p-2 text-right">è²¸æ–¹ (Credit)</th><th className="p-2"></th></tr></thead>
                                            <tbody>
                                                {entryRows.map((row, idx) => (
                                                    <tr key={idx} className="border-b">
                                                        <td className="p-2"><select className="w-full border rounded p-2 font-mono" value={row.account} onChange={e=>handleRowChange(idx, 'account', e.target.value)}><option value="">è«‹é¸æ“‡...</option>{accounts.map(a => <option key={a.code} value={a.code}>{a.code} {a.name}</option>)}</select></td>
                                                        <td className="p-2"><input type="number" className="w-full border rounded p-2 text-right" value={row.debit || ''} onChange={e=>handleRowChange(idx, 'debit', e.target.value)} /></td>
                                                        <td className="p-2"><input type="number" className="w-full border rounded p-2 text-right" value={row.credit || ''} onChange={e=>handleRowChange(idx, 'credit', e.target.value)} /></td>
                                                        <td className="p-2 text-center"><button onClick={()=>removeRow(idx)} className="text-red-400 hover:text-red-600 font-bold">Ã—</button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot><tr className="font-bold text-slate-700 bg-slate-50"><td className="p-2 text-right">åˆè¨ˆï¼š</td><td className={`p-2 text-right ${entryRows.reduce((s,r)=>s+Number(r.debit),0)!==entryRows.reduce((s,r)=>s+Number(r.credit),0)?'text-red-500':'text-green-600'}`}>{new Intl.NumberFormat().format(entryRows.reduce((s,r)=>s+Number(r.debit),0))}</td><td className={`p-2 text-right ${entryRows.reduce((s,r)=>s+Number(r.debit),0)!==entryRows.reduce((s,r)=>s+Number(r.credit),0)?'text-red-500':'text-green-600'}`}>{new Intl.NumberFormat().format(entryRows.reduce((s,r)=>s+Number(r.credit),0))}</td><td></td></tr></tfoot>
                                        </table>
                                        <button onClick={addRow} className="text-blue-600 text-sm font-bold hover:underline">+ æ–°å¢ä¸€è¡Œ</button>
                                    </div>
                                    <div className="p-4 border-t bg-slate-50 flex justify-end gap-2"><button onClick={()=>setShowModal(false)} className="px-4 py-2 text-slate-500 font-bold">å–æ¶ˆ</button><button onClick={saveManualEntry} className="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow">ç¢ºèªå„²å­˜</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AccountingApp />);
    </script>
</body>
</html>