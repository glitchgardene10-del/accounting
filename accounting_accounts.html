<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè¨ˆç§‘ç›®è¨­å®š - å…‰ç¥é•·ç…§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    
    <script>
        // 1. å‰ç«¯ç°¡æ˜“é©—è­‰ (é˜²å›å­)
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” è«‹å…ˆå¾ä¸»ç³»çµ±ç™»å…¥ï¼");
                window.location.href = 'index.html'; 
            }
        })();
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .category-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 9999px; font-weight: bold; }
        .cat-1 { background: #dbeafe; color: #1e40af; } 
        .cat-2 { background: #fce7f3; color: #9d174d; } 
        .cat-3 { background: #f3f4f6; color: #1f2937; } 
        .cat-4 { background: #dcfce7; color: #166534; } 
        .cat-5 { background: #ffedd5; color: #9a3412; } 
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // â˜…â˜…â˜… ä¿®æ­£é» 1: åŒ¯å…¥ Auth æ¨¡çµ„
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // â˜…â˜…â˜… ä¿®æ­£é» 2: åˆå§‹åŒ– Auth

        // å…¨åŸŸç¶å®š
        window.loadAccounts = loadAccounts;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveAccount = saveAccount;
        window.deleteAccount = deleteAccount;
        window.initDefaults = initDefaults;

        let allAccounts = [];

        // â˜…â˜…â˜… ä¿®æ­£é» 3: ç­‰å¾… Firebase èªè­‰å®Œæˆå¾Œæ‰è®€å–è³‡æ–™
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Firebase Auth Ready:", user.uid);
                loadAccounts(); // èªè­‰æˆåŠŸï¼ŒåŸ·è¡Œè®€å–
            } else {
                console.warn("Firebase Auth Failed or Not Logged In");
                // é€™è£¡ä¸éœ€å¼·åˆ¶è¸¢äººï¼Œå› ç‚ºæœ€ä¸Šé¢çš„ sessionStorage å·²ç¶“æ“‹éäº†ï¼Œä¸”æœƒé€ æˆå¾ªç’°
            }
        });

        async function loadAccounts() {
            const list = document.getElementById('account-list');
            list.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-400">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                const q = query(collection(db, "accounting_accounts"), orderBy("code"));
                const snap = await getDocs(q);
                
                allAccounts = [];
                snap.forEach(d => allAccounts.push(d.data()));

                renderTable();
            } catch (e) {
                console.error("Load Error:", e); // é€™é‚Šå¯ä»¥çœ‹åˆ°å…·é«”éŒ¯èª¤
                list.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-400">è®€å–å¤±æ•—ï¼šæ¬Šé™ä¸è¶³æˆ–ç¶²è·¯éŒ¯èª¤</td></tr>';
            }
        }

        function renderTable() {
            const list = document.getElementById('account-list');
            list.innerHTML = '';
            
            if (allAccounts.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            const categoryMap = {
                "1": "è³‡ç”¢ (Assets)",
                "2": "è² å‚µ (Liabilities)",
                "3": "æ¬Šç›Š (Equity)",
                "4": "æ”¶å…¥ (Revenue)",
                "5": "è²»ç”¨ (Expenses)"
            };

            allAccounts.forEach(acc => {
                const catCode = acc.code.charAt(0);
                const catName = categoryMap[catCode] || "å…¶ä»–";
                const catClass = `cat-${catCode}`;

                list.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-4 font-mono font-bold text-slate-700">${acc.code}</td>
                        <td class="p-4 font-bold text-slate-800">${acc.name}</td>
                        <td class="p-4"><span class="category-badge ${catClass}">${catName}</span></td>
                        <td class="p-4 text-right">
                            <button onclick="deleteAccount('${acc.code}')" class="text-slate-400 hover:text-red-500 transition px-2 py-1 rounded hover:bg-red-50">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openModal() { document.getElementById('modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function saveAccount() {
            const code = document.getElementById('acc-code').value.trim();
            const name = document.getElementById('acc-name').value.trim();
            
            if(!code || !name) return alert("è«‹å¡«å¯«å®Œæ•´");
            if(code.length !== 4 || isNaN(code)) return alert("ç§‘ç›®ä»£ç¢¼å¿…é ˆç‚º 4 ä½æ•¸å­— (ä¾‹å¦‚ 1101)");

            const btn = document.getElementById('btn-save');
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            try {
                await setDoc(doc(db, "accounting_accounts", code), {
                    code, name, 
                    category: code.charAt(0) 
                });
                closeModal();
                document.getElementById('acc-code').value = '';
                document.getElementById('acc-name').value = '';
                loadAccounts();
            } catch(e) {
                alert("å„²å­˜å¤±æ•—");
            } finally {
                btn.innerText = "ç¢ºèªæ–°å¢";
                btn.disabled = false;
            }
        }

        async function deleteAccount(code) {
            if(!confirm(`ç¢ºå®šåˆªé™¤ç§‘ç›® [${code}] å—ï¼Ÿ`)) return;
            try {
                await deleteDoc(doc(db, "accounting_accounts", code));
                loadAccounts();
            } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
        }

        async function initDefaults() {
            if(!confirm("é€™å°‡æœƒè‡ªå‹•å»ºç«‹ä¸€å¥—ã€Œé•·ç…§æ©Ÿæ§‹å°ˆç”¨ã€çš„æœƒè¨ˆç§‘ç›®è¡¨ã€‚\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ")) return;

            const defaults = [
                // 1. è³‡ç”¢
                { code: "1101", name: "åº«å­˜ç¾é‡‘ (é›¶ç”¨é‡‘)" },
                { code: "1102", name: "éŠ€è¡Œå­˜æ¬¾-ç‰å±±" },
                { code: "1103", name: "éŠ€è¡Œå­˜æ¬¾-éƒµå±€" },
                { code: "1140", name: "æ‡‰æ”¶å¸³æ¬¾-é•·ç…§è£œåŠ©" },
                { code: "1141", name: "æ‡‰æ”¶å¸³æ¬¾-è‡ªè²»" },
                
                // 2. è² å‚µ
                { code: "2101", name: "æ‡‰ä»˜è–ªè³‡" },
                { code: "2201", name: "ä»£æ‰£å‹ä¿è²»" },
                { code: "2202", name: "ä»£æ‰£å¥ä¿è²»" },
                { code: "2203", name: "ä»£æ‰£å‹é€€è‡ªæ" },
                { code: "2204", name: "æ‡‰ä»˜é€€ä¼‘é‡‘ (é›‡ä¸»ææ’¥)" },
                { code: "2801", name: "è‚¡æ±å¾€ä¾† (è€é—†å¢Šæ¬¾)" },

                // 3. æ¬Šç›Š
                { code: "3101", name: "è³‡æœ¬é¡" },
                { code: "3351", name: "ç´¯ç©ç›ˆè™§" },

                // 4. æ”¶å…¥
                { code: "4101", name: "é•·ç…§æ”¶å…¥-Bç¢¼ (ç…§é¡§)" },
                { code: "4102", name: "é•·ç…§æ”¶å…¥-Gç¢¼ (å–˜æ¯)" },
                { code: "4103", name: "é•·ç…§æ”¶å…¥-AAç¢¼ (åŠ çµ¦)" },
                { code: "4201", name: "è‡ªè²»æœå‹™æ”¶å…¥" },
                { code: "4901", name: "å…¶ä»–æ”¶å…¥" },

                // 5. è²»ç”¨
                { code: "5101", name: "è–ªè³‡æ”¯å‡º-å±…æœå“¡" },
                { code: "5102", name: "è–ªè³‡æ”¯å‡º-è¡Œæ”¿äººå“¡" },
                { code: "5103", name: "é€€ä¼‘é‡‘æ”¯å‡º" },
                { code: "5104", name: "åŠ ç­è²»" },
                { code: "5105", name: "å‹å¥ä¿è²»ç”¨ (é›‡ä¸»è² æ“”)" },
                { code: "5201", name: "ç§Ÿé‡‘æ”¯å‡º" },
                { code: "5202", name: "æ°´é›»ç“¦æ–¯è²»" },
                { code: "5203", name: "éƒµé›»è²» (é›»è©±/ç¶²è·¯)" },
                { code: "5204", name: "æ–‡å…·ç”¨å“" },
                { code: "5205", name: "äº¤é€šè²»/æ²¹è³‡" },
                { code: "5206", name: "ä¿®ç¹•è²»" },
                { code: "5207", name: "é¤è²»/ä¼™é£Ÿ" },
                { code: "5208", name: "ä¿éšªè²» (è²¬ä»»éšª)" },
                { code: "5209", name: "æ•™è‚²è¨“ç·´è²»" },
                { code: "5299", name: "é›œé …æ”¯å‡º" }
            ];

            const btn = document.getElementById('btn-init');
            btn.innerText = "å¯«å…¥ä¸­...";
            btn.disabled = true;

            const batch = writeBatch(db);
            defaults.forEach(acc => {
                const ref = doc(db, "accounting_accounts", acc.code);
                batch.set(ref, { ...acc, category: acc.code.charAt(0) });
            });

            try {
                await batch.commit();
                alert("âœ… ç§‘ç›®å»ºç«‹å®Œæˆï¼");
                loadAccounts();
            } catch(e) {
                console.error(e);
                alert("å»ºç«‹å¤±æ•—");
            } finally {
                btn.innerText = "âš¡ ä¸€éµåŒ¯å…¥æ¨™æº–ç§‘ç›®";
                btn.disabled = false;
            }
        }
    </script>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-slate-800 p-6 flex justify-between items-center text-white">
            <div>
                <h1 class="text-2xl font-black tracking-wide">æœƒè¨ˆç§‘ç›®è¨­å®š</h1>
                <p class="text-slate-400 text-sm">Chart of Accounts</p>
            </div>
            <a href="accounting_portal.html" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-bold transition">â†© è¿”å›å¸³å‹™ä¸­å¿ƒ</a>
        </div>

        <div class="p-6 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
            <div class="text-sm text-slate-500">
                ç®¡ç†å…§å¸³ç³»çµ±ä½¿ç”¨çš„æœƒè¨ˆé …ç›®ã€‚
            </div>
            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                <span>â•</span> æ–°å¢ç§‘ç›®
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-100 text-slate-600 uppercase font-bold text-xs sticky top-0">
                    <tr>
                        <th class="p-4 w-24">ä»£ç¢¼</th>
                        <th class="p-4">ç§‘ç›®åç¨±</th>
                        <th class="p-4 w-32">é¡åˆ¥</th>
                        <th class="p-4 w-20 text-right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="account-list" class="divide-y divide-slate-100">
                    </tbody>
            </table>
        </div>

        <div id="empty-state" class="hidden p-12 text-center bg-white">
            <div class="text-6xl mb-4">ğŸ“‚</div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">ç›®å‰æ²’æœ‰ä»»ä½•ç§‘ç›®</h3>
            <p class="text-slate-500 mb-6">æ‚¨å¯ä»¥æ‰‹å‹•æ–°å¢ï¼Œæˆ–ç›´æ¥ä½¿ç”¨é è¨­æ¨¡æ¿ã€‚</p>
            <button id="btn-init" onclick="initDefaults()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-full font-bold shadow-lg transition transform hover:scale-105">
                âš¡ ä¸€éµåŒ¯å…¥ã€Œé•·ç…§æ©Ÿæ§‹ã€æ¨™æº–ç§‘ç›®
            </button>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div class="bg-slate-800 p-4 text-white font-bold flex justify-between items-center">
                <span>æ–°å¢ç§‘ç›®</span>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ç§‘ç›®ä»£ç¢¼ (4ç¢¼)</label>
                    <input type="number" id="acc-code" class="w-full border-2 border-slate-200 rounded-lg p-2 font-mono font-bold focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚: 1101">
                    <p class="text-[10px] text-slate-400 mt-1">1é–‹é ­=è³‡ç”¢, 2=è² å‚µ, 3=æ¬Šç›Š, 4=æ”¶å…¥, 5=è²»ç”¨</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ç§‘ç›®åç¨±</label>
                    <input type="text" id="acc-name" class="w-full border-2 border-slate-200 rounded-lg p-2 font-bold focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚: é›¶ç”¨é‡‘">
                </div>
                <button id="btn-save" onclick="saveAccount()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow mt-2">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

</body>
</html>