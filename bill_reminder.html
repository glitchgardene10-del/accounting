<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾…ç¹³å¸³å–®/è«‹æ¬¾ä¸­å¿ƒ (v3.0 é€£å‹•ç‰ˆ)</title>
    
    <script>
        (function() {
            const userSession = sessionStorage.getItem('kuangyou_user');
            if (!userSession) {
                alert("â›” è«‹å…ˆç™»å…¥ï¼");
                window.location.href = 'index.html'; 
                return;
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, deleteDoc, doc, updateDoc, writeBatch, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDkC6kfqpmEeMKIvWIqftounTSH_NPp25M",
            authDomain: "assessmentsystem-9e2ec.firebaseapp.com",
            projectId: "assessmentsystem-9e2ec",
            storageBucket: "assessmentsystem-9e2ec.firebasestorage.app",
            messagingSenderId: "455151254122",
            appId: "1:455151254122:web:45787cfce4469bff90e813",
            measurementId: "G-201C6BE86Z"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        window.increment = increment;
        window.getDocs = getDocs;

        onAuthStateChanged(window.auth, (user) => {
            if (user) window.isAuthReady = true;
        });
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const EXPENSE_TYPES = [
            { name: "æ°´é›»è²»", code: "5202" },
            { name: "é›»è©±/ç¶²è·¯è²»", code: "5203" },
            { name: "å‹å¥ä¿è²» (å…¬å¸è² æ“”)", code: "5105" },
            { name: "å‹å¥ä¿/é€€ä¼‘é‡‘ (ç¹³ç´ç¸½é¡)", code: "2201" }, 
            { name: "å» å•†è²¨æ¬¾", code: "5204" },
            { name: "æˆ¿ç§Ÿ", code: "5201" },
            { name: "å…¶ä»–", code: "5299" }
        ];

        const BillApp = () => {
            const [bills, setBills] = useState([]);
            const [loading, setLoading] = useState(false);
            const [currentUser, setCurrentUser] = useState(JSON.parse(sessionStorage.getItem('kuangyou_user') || '{}'));
            
            // æ¬Šé™ç®¡ç†
            const [isManager, setIsManager] = useState(false);
            const BOSS_EMAILS = ["admin@kuangyou.internal"]; 

            // éŠ€è¡Œåˆ—è¡¨ç‹€æ…‹
            const [bankOptions, setBankOptions] = useState([]);

            // æ–°å¢è¡¨å–®
            const [showForm, setShowForm] = useState(false);
            const [title, setTitle] = useState('');
            const [amount, setAmount] = useState('');
            const [dueDate, setDueDate] = useState(dayjs().format('YYYY-MM-DD'));
            const [type, setType] = useState('5202'); 
            const [note, setNote] = useState('');

            // ä»˜æ¬¾ç¢ºèªè¦–çª—
            const [showPayModal, setShowPayModal] = useState(false);
            const [selectedBill, setSelectedBill] = useState(null);
            const [paymentMethod, setPaymentMethod] = useState('bank'); // bank or cash_1101
            const [selectedBank, setSelectedBank] = useState('');

            useEffect(() => {
                const unsubscribeAuth = window.auth.onAuthStateChanged((user) => {
                    if (user) {
                        if (BOSS_EMAILS.includes(user.email)) setIsManager(true);
                        else setIsManager(false);
                    }
                });

                // 1. ç›£è½å¸³å–®
                const q = window.query(
                    window.collection(window.db, "bill_requests"),
                    window.orderBy("dueDate", "asc")
                );

                const unsubscribeBills = window.onSnapshot(q, (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    // ç°¡å–®éæ¿¾ï¼šåªé¡¯ç¤ºã€Œæœªä»˜æ¬¾ã€æˆ–æ˜¯ã€Œæœ€è¿‘7å¤©å…§ä»˜éã€çš„
                    const showList = list.filter(b => b.status === 'pending' || dayjs(b.paidAt).isAfter(dayjs().subtract(7, 'day')));
                    setBills(showList);
                });

                // 2. æŠ“å–éŠ€è¡Œç§‘ç›® (1102~1105)
                const fetchBanks = async () => {
                    try {
                        const qAcc = window.query(window.collection(window.db, "accounting_accounts"), window.orderBy("code"));
                        const snap = await window.getDocs(qAcc);
                        const banks = [];
                        snap.forEach(d => {
                            const data = d.data();
                            const code = String(data.code);
                            if (code.startsWith('1102') || code.startsWith('1103') || code.startsWith('1104') || code.startsWith('1105')) {
                                banks.push({ code: data.code, name: data.name });
                            }
                        });
                        if(banks.length === 0) banks.push({ code: '1102', name: 'éŠ€è¡Œå­˜æ¬¾' });
                        setBankOptions(banks);
                        setSelectedBank(banks[0]?.code);
                    } catch(e) {}
                };
                fetchBanks();

                return () => { unsubscribeAuth(); unsubscribeBills(); };
            }, []);

            const handleSubmit = async () => {
                if (!title || !amount) return alert("è«‹å¡«å¯«å®Œæ•´");
                setLoading(true);
                try {
                    await window.addDoc(window.collection(window.db, "bill_requests"), {
                        title,
                        amount: Number(amount),
                        dueDate,
                        typeCode: type,
                        typeName: EXPENSE_TYPES.find(t=>t.code===type)?.name,
                        note,
                        requester: currentUser.name,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                    alert("âœ… å·²é€å‡ºçµ¦è€é—†ï¼");
                    setShowForm(false);
                    setTitle(''); setAmount(''); setNote('');
                } catch(e) { alert("å¤±æ•—: " + e.message); }
                setLoading(false);
            };

            const openPayModal = (bill) => {
                if (!isManager) return alert("â›” æ¬Šé™ä¸è¶³ï¼šåªæœ‰è€é—†å¯ä»¥åŸ·è¡Œä»˜æ¬¾ã€‚");
                setSelectedBill(bill);
                setShowPayModal(true);
            };

            const confirmPay = async () => {
                if (!selectedBill) return;
                setLoading(true);
                try {
                    const batch = window.writeBatch(window.db);
                    
                    // 1. æ›´æ–°å¸³å–®ç‹€æ…‹
                    const billRef = window.doc(window.db, "bill_requests", selectedBill.id);
                    batch.update(billRef, {
                        status: 'paid',
                        paidAt: new Date().toISOString(),
                        payer: currentUser.name,
                        paymentMethod: paymentMethod, 
                        paymentSource: paymentMethod === 'bank' ? selectedBank : '1101'
                    });

                    // 2. è‡ªå‹•ç”¢ç”Ÿæœƒè¨ˆå‚³ç¥¨ (è€é—†æœ€æ„›çš„åŠŸèƒ½)
                    const journalRef = window.doc(window.collection(window.db, "accounting_journal"));
                    
                    let debitEntry;
                    if (selectedBill.typeCode === '2201') {
                        debitEntry = { type: 'debit', code: '2201', name: 'ä»£æ‰£æ¬¾/æ‡‰ä»˜è²»ç”¨', amount: selectedBill.amount };
                    } else {
                        debitEntry = { type: 'debit', code: selectedBill.typeCode, name: selectedBill.typeName, amount: selectedBill.amount };
                    }

                    // æ±ºå®šè²¸æ–¹ç§‘ç›® (éŠ€è¡Œ or 1101 åº«å­˜ç¾é‡‘)
                    let creditEntry;
                    if (paymentMethod === 'bank') {
                        const bankName = bankOptions.find(b=>b.code===selectedBank)?.name || 'éŠ€è¡Œå­˜æ¬¾';
                        creditEntry = { type: 'credit', code: selectedBank, name: bankName, amount: selectedBill.amount };
                    } else {
                        // â˜… è€é—†ä»˜æ¬¾ï¼šæ‰£ 1101 åº«å­˜ç¾é‡‘
                        creditEntry = { type: 'credit', code: '1101', name: 'åº«å­˜ç¾é‡‘', amount: selectedBill.amount };
                    }

                    batch.set(journalRef, {
                        date: dayjs().format('YYYY-MM-DD'),
                        description: `æ”¯ä»˜å¸³å–®: ${selectedBill.title}`,
                        source: 'BILL_PAYMENT',
                        relatedBillId: selectedBill.id, // â˜…â˜…â˜… é—œéµï¼šç¶å®šå¸³å–® IDï¼Œè®“ç¸½å¸³çŸ¥é“é€™æ˜¯å“ªç­†å¸³å–®
                        entries: [debitEntry, creditEntry],
                        totalAmount: selectedBill.amount,
                        createdAt: new Date().toISOString(),
                        recorder: currentUser.name
                    });

                    await batch.commit();
                    alert("âœ… ä»˜æ¬¾å®Œæˆï¼å‚³ç¥¨å·²è‡ªå‹•å»ºç«‹ã€‚");
                    setShowPayModal(false);

                } catch(e) { console.error(e); alert("è™•ç†å¤±æ•—"); }
                setLoading(false);
            };

            const handleDelete = async (id) => {
                if(confirm("åˆªé™¤æ­¤è«‹æ±‚ï¼Ÿ")) await window.deleteDoc(window.doc(window.db, "bill_requests", id));
            };

            const totalPending = bills.filter(b => b.status === 'pending').reduce((s, b) => s + b.amount, 0);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-slate-100 shadow-2xl">
                    <div className="bg-slate-800 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-10">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h1 className="text-2xl font-black tracking-wider">å¾…ç¹³å¸³å–®</h1>
                                <p className="text-xs text-slate-400">Bill Payment Center</p>
                            </div>
                            <a href="accounting_portal.html" className="text-xs bg-slate-700 px-3 py-1 rounded-full hover:bg-slate-600">å›é¦–é </a>
                        </div>
                        
                        <div className="bg-slate-700/50 p-4 rounded-xl flex justify-between items-center border border-slate-600">
                            <span className="text-sm font-bold text-slate-300">å¾…ä»˜ç¸½é¡</span>
                            <span className="text-3xl font-black text-yellow-400">${new Intl.NumberFormat().format(totalPending)}</span>
                        </div>
                    </div>

                    <div className="p-4 flex-1 overflow-y-auto pb-24 space-y-4">
                        {bills.length === 0 && <div className="text-center text-slate-400 py-10">ç›®å‰æ²’æœ‰å¸³å–®ï¼Œå¤ªæ£’äº†ï¼ğŸ‰</div>}
                        
                        {bills.map(bill => {
                            const isExpired = bill.status === 'pending' && dayjs().isAfter(dayjs(bill.dueDate));
                            const isUrgent = bill.status === 'pending' && dayjs(bill.dueDate).diff(dayjs(), 'day') <= 3;
                            
                            return (
                                <div key={bill.id} className={`bg-white rounded-xl p-4 shadow-sm border-l-4 relative ${bill.status === 'paid' ? 'border-l-green-500 opacity-60' : (isExpired ? 'border-l-red-600 bg-red-50' : (isUrgent ? 'border-l-orange-400' : 'border-l-blue-500'))}`}>
                                    
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-bold text-lg text-slate-800">{bill.title}</div>
                                            <div className="text-xs text-slate-500 flex gap-2 mt-1">
                                                <span className="bg-slate-100 px-2 py-0.5 rounded">{bill.typeName}</span>
                                                <span>æœŸé™: {bill.dueDate}</span>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-xl font-black font-mono text-slate-700">${new Intl.NumberFormat().format(bill.amount)}</div>
                                            <div className="text-[10px] text-slate-400">{bill.requester} æå ±</div>
                                        </div>
                                    </div>

                                    {bill.note && <div className="text-sm text-slate-600 bg-slate-50 p-2 rounded mb-3">{bill.note}</div>}

                                    {bill.status === 'pending' ? (
                                        <div className="flex gap-2 mt-2">
                                            {isManager ? (
                                                <button onClick={()=>openPayModal(bill)} className="flex-1 bg-slate-900 text-white py-2 rounded-lg font-bold shadow hover:bg-black active:scale-95 transition flex items-center justify-center gap-2">
                                                    <span>ğŸ’³</span> ç¢ºèªä»˜æ¬¾
                                                </button>
                                            ) : (
                                                <div className="flex-1 text-center text-xs text-slate-400 italic py-2">
                                                    ç­‰å¾…è€é—†ä»˜æ¬¾...
                                                </div>
                                            )}
                                            <button onClick={()=>handleDelete(bill.id)} className="px-3 text-slate-300 hover:text-red-500">ğŸ—‘ï¸</button>
                                        </div>
                                    ) : (
                                        <div className="text-center text-xs font-bold text-green-600 border-t pt-2 mt-2">
                                            âœ… å·²ä»˜æ¬¾ ({dayjs(bill.paidAt).format('MM/DD')})
                                        </div>
                                    )}
                                    
                                    {isExpired && bill.status === 'pending' && (
                                        <div className="absolute top-2 right-2 text-[10px] font-bold bg-red-600 text-white px-2 py-0.5 rounded-full animate-pulse">
                                            å·²éæœŸ
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    <button onClick={()=>setShowForm(true)} className="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl font-bold hover:bg-blue-700 hover:scale-110 transition z-50">ï¼‹</button>

                    {/* Add Form Modal */}
                    {showForm && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
                                <div className="bg-slate-800 p-4 text-white font-bold flex justify-between">
                                    <span>æ–°å¢è«‹æ¬¾å–®</span>
                                    <button onClick={()=>setShowForm(false)}>âœ•</button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">å¸³å–®åç¨±</label><input type="text" className="w-full border-2 rounded-lg p-2" placeholder="ä¾‹å¦‚: 12æœˆé›»è²»" value={title} onChange={e=>setTitle(e.target.value)} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full border-2 rounded-lg p-2 font-mono" placeholder="$" value={amount} onChange={e=>setAmount(e.target.value)} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">ç¹³è²»æœŸé™</label><input type="date" className="w-full border-2 rounded-lg p-2" value={dueDate} onChange={e=>setDueDate(e.target.value)} /></div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">è²»ç”¨åˆ†é¡ (ç”¨æ–¼è‡ªå‹•åšå¸³)</label>
                                        <select className="w-full border-2 rounded-lg p-2 bg-white" value={type} onChange={e=>setType(e.target.value)}>
                                            {EXPENSE_TYPES.map(t => <option key={t.code} value={t.code}>{t.name}</option>)}
                                        </select>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">å‚™è¨»</label><textarea className="w-full border-2 rounded-lg p-2 h-20 text-sm" placeholder="éŠ€è¡Œä»£ç¢¼: xxx å¸³è™Ÿ: xxx" value={note} onChange={e=>setNote(e.target.value)}></textarea></div>
                                    <button onClick={handleSubmit} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700">é€å‡ºæé†’</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Pay Modal (Updated) */}
                    {showPayModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 animate-slide-up">
                                <h3 className="text-xl font-bold text-slate-800 mb-4">ç¢ºèªä»˜æ¬¾</h3>
                                <div className="mb-4 text-sm text-slate-600">
                                    æ”¯ä»˜ï¼š<b>{selectedBill?.title}</b><br/>
                                    é‡‘é¡ï¼š<b className="text-red-600 font-mono text-lg">${new Intl.NumberFormat().format(selectedBill?.amount)}</b>
                                </div>
                                
                                <div className="space-y-3 mb-6">
                                    <label className="block text-xs font-bold text-slate-500">ä»˜æ¬¾æ–¹å¼</label>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setPaymentMethod('bank')} className={`flex-1 py-2 rounded border-2 text-sm font-bold ${paymentMethod==='bank'?'border-blue-500 bg-blue-50 text-blue-700':'border-slate-200'}`}>ğŸ¦ éŠ€è¡Œè½‰å¸³</button>
                                        <button onClick={()=>setPaymentMethod('cash_1101')} className={`flex-1 py-2 rounded border-2 text-sm font-bold ${paymentMethod==='cash_1101'?'border-emerald-500 bg-emerald-50 text-emerald-700':'border-slate-200'}`}>ğŸ’µ åº«å­˜ç¾é‡‘(1101)</button>
                                    </div>

                                    {paymentMethod === 'bank' && (
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">é¸æ“‡éŠ€è¡Œ</label>
                                            <select className="w-full border rounded p-2 text-sm" value={selectedBank} onChange={e=>setSelectedBank(e.target.value)}>
                                                {bankOptions.map(b => <option key={b.code} value={b.code}>{b.code} {b.name}</option>)}
                                            </select>
                                        </div>
                                    )}
                                </div>

                                <div className="flex gap-2">
                                    <button onClick={()=>setShowPayModal(false)} className="flex-1 bg-gray-200 text-gray-600 font-bold py-3 rounded-lg">å–æ¶ˆ</button>
                                    <button onClick={confirmPay} className="flex-1 bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-black">ç¢ºèªæ”¯ä»˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BillApp />);
    </script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
    </style>
</body>
</html>